<!doctype html>
<html>
<head><meta charset="utf-8"><title>Trading - NCCR Portal v2</title><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="assets/styles.css"><script src="https://cdn.jsdelivr.net/npm/chart.js"></script></head>
<body onload="requireAuth()">
  <div class="topbar"><div class="brand"><div class="logo-badge">N</div> NCCR Portal</div><div class="top-actions"><div id="header-user" class="small"></div><button id="logout-btn" class="btn">Logout</button></div></div>
  <div class="app">
    <aside class="sidebar"><div style="font-weight:700">Navigation</div><div class="nav"><a href="dashboard.html">Dashboard</a><a href="projects.html">Projects</a><a href="ngos.html">NGOs</a><a href="credits.html">Credits</a><a href="trading.html" class="active">Trading</a><a href="profile.html">Profile</a><a href="notifications.html">Notifications</a></div></aside>
    <main class="main">
      <div class="header-row"><div><h2>Trading Simulation</h2><div class="small">Simulate credit trades (local only)</div></div><div><button id="clear" class="btn">Clear Trades</button></div></div>
      <div class="card">
        <div class="table-wrap"><table class="table" id="tradeTable"><thead><tr><th>Credit ID</th><th>Project ID</th><th>Available</th><th>Owner</th><th>Action</th></tr></thead><tbody></tbody></table></div>
      </div>
      <div style="margin-top:12px" class="card"><h3>Total Traded</h3><canvas id="tradeChart"></canvas></div>
    </main>
  </div>

<script src="assets/app.js"></script>
<script>
requireAuth();
const data = NCCR.ensureDemoData();
let trades = data.trades || [];

function renderTable(){
  const tbody = document.querySelector('#tradeTable tbody');
  tbody.innerHTML = '';
  data.credits.forEach(c=>{
    const available = Math.max(0, Math.round(c.amount * 0.2));
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.id}</td><td>${c.project}</td><td>${NCCR.formatNumber(available)}</td><td>${c.owner}</td><td><button class="btn-primary" onclick="doTrade('${c.id}')">Trade</button></td>`;
    tbody.appendChild(tr);
  });
}
function doTrade(creditId){
  const credit = data.credits.find(c=>c.id===creditId);
  if(!credit) return;
  const qty = Math.min(Math.max(1, Math.round(credit.amount*0.1)), credit.amount);
  const day = new Date().toLocaleDateString();
  trades.push({day, amount: qty, creditId});
  // persist
  const d = NCCR.ensureDemoData();
  d.trades = trades;
  NCCR.saveData(d);
  alert('Traded '+qty+' tCO₂e from '+creditId);
  renderChart();
}
function aggregate(){
  const map = {};
  trades.forEach(t=> map[t.day] = (map[t.day]||0) + t.amount);
  return Object.keys(map).map(k=>({day:k, amount:map[k]}));
}
let chart;
function renderChart(){
  const ctx = document.getElementById('tradeChart').getContext('2d');
  const agg = aggregate();
  const labels = agg.map(a=>a.day);
  const vals = agg.map(a=>a.amount);
  if(chart) chart.destroy();
  chart = new Chart(ctx, {type:'bar', data:{labels, datasets:[{label:'tCO₂e', data:vals}]}, options:{}});
}
document.getElementById('clear').addEventListener('click', ()=>{
  trades = [];
  const d = NCCR.ensureDemoData();
  d.trades = trades;
  NCCR.saveData(d);
  renderChart();
  alert('Cleared trades');
});
renderTable();
renderChart();
</script>
</body>
</html>
